# C4: Context, Containers e Componentes (Módulos Fiscais Contta)

> Visão gerada automaticamente a partir do inventário do monorepo. Ajuste nomes/URLs conforme deploy final (Render/Vercel/Keycloak).

## C4-Context

```mermaid
C4Context
    title Contta - Contexto de Alto Nível
    Person(Usuario, "Usuário", "Cliente/contador que acessa o Portal Contta")
    System_Boundary(Contta, "Plataforma Contta"){
      System(API, "Contta Schedule API", "ASP.NET Core 3.1", "APIs de NF-e/NFS-e, apuração ICMS/IPI/PIS/COFINS, Simples")
      System(SearchApi, "Contta Search API", "Node/TS", "Consultas e buscas auxiliares")
      System(Portal, "Portal Simples", "React (Vercel)", "Front para empresas e contadores")
      System(Sped, "SPED Workers", ".NET Console", "Geração/validação EFD/ECD/ECF")
      System(Crawlers, "Crawlers", ".NET + AngleSharp", "Coleta anexos Simples, NCM, legislações")
    }
    System_Ext(Render, "Render.com", "Infra de deploy das APIs e workers")
    System_Ext(Vercel, "Vercel", "Infra do frontend")
    System_Ext(Keycloak, "Keycloak", "OIDC (Authorization Code + PKCE)")
    System_Ext(Mongo, "MongoDB", "Banco de dados fiscal")
    System_Ext(Rabbit, "RabbitMQ", "Fila de processamento")

    Rel(Usuario, Portal, "Usa via browser")
    Rel(Portal, Keycloak, "Login OIDC + PKCE")
    Rel(Portal, API, "REST/JSON")
    Rel(API, Mongo, "CRUD fiscal")
    Rel(API, Rabbit, "Publica jobs")
    Rel(Sped, Mongo, "Lê/Grava dados SPED")
    Rel(Crawlers, Mongo, "Atualiza tabelas externas")
    Rel(API, Keycloak, "Valida tokens (Bearer)")
    Rel(API, SearchApi, "Chamada auxiliar")
    Rel(API, Sped, "Dispara/consulta apurações")
    Rel(API, Render, "Deploy (Blueprint)")
    Rel(Portal, Vercel, "Deploy")
```

## C4-Container

```mermaid
C4Container
    title Contta - Containers Principais
    Person(Usuario, "Usuário")
    System_Boundary(Contta, "Plataforma Contta"){
      Container(API, "Corporate.Contta.Schedule.Api", "ASP.NET Core 3.1", "Endpoints: /api/nfe, /api/impostos, /api/company, /api/access, /api/agblocoe...")
      Container(App, "Corporate.Contta.Schedule.Application", ".NET Standard", "MediatR, DTOs/Handlers, validações")
      Container(Domain, "Corporate.Contta.Schedule.Domain", ".NET Standard", "Entidades: NFe, Produto, Tabelas, Apuração, Empresa")
      Container(Infra, "Corporate.Contta.Schedule.Infra", ".NET Standard", "MongoDB, Repos, Crawlers, RabbitMQ, Redis")
      Container(Sped, "Corporate.Contta.Schedule.SpedContta", "Console .NET Core", "EFD/ECD/ECF (EPPlus/Mongo)")
      Container(Portal, "portal-simples-front-end", "React", "UI/Fluxos de apuração e produtos")
      Container(Search, "contta-search-api", "Node/TS", "Serviços auxiliares")
      Container(ExcelParser, "contta-excel-parser", "Node/TS", "Importação planilhas")
      Container(Auth, "Keycloak", "Java", "OIDC Provider")
      ContainerDb(Mongo, "MongoDB", "Atlas/Replica" ,"Notas, Itens, Apurações, Empresas, Tabelas")
      ContainerQueue(Rabbit, "RabbitMQ", "Mensageria")
    }
    Rel(Usuario, Portal, "HTTPs")
    Rel(Portal, Auth, "OIDC + PKCE")
    Rel(Portal, API, "REST/JSON")
    Rel(API, App, "MediatR")
    Rel(App, Domain, "Entidades/Serviços")
    Rel(App, Infra, "Repos/Integradores")
    Rel(Infra, Mongo, "Mongo Driver")
    Rel(API, Auth, "Validate JWT (Bearer)")
    Rel(API, Sped, "Triggers/consulta")
    Rel(Infra, Rabbit, "Publica/consome")
```

## C4-Component (foco fiscal)

```mermaid
C4Component
    title Contta - Componentes chave (fiscal)
    Container(API, "Corporate.Contta.Schedule.Api")
    Component(CtrlNfe, "NfeController", "Rotas NF-e/NFS-e, livros, bloco E")
    Component(CtrlImp, "ImpostosController", "CFOP, regras ICMS, exceções")
    Component(CtrlComp, "CompanyController", "Empresas, faturamento RBT12, anexos")
    Component(CtrlAccess, "AccessController", "Login e emissão de token")
    Component(CtrlAgE, "AgBlocoEController", "Agendamento/consulta Bloco E")

    Container(App, "Corporate.Contta.Schedule.Application")
    Component(Mediatr, "Handlers MediatR", "Processamento de comandos/queries")

    Container(Domain, "Corporate.Contta.Schedule.Domain")
    Component(EntNfe, "Entidades NFe/Item", "CFOP, CST/CSOSN, bases/aliquotas")
    Component(Tabelas, "Tabelas Fiscais", "Anexos Simples, NCM, CFOP, NAT_BC_CRED")
    Component(Apur, "Apuração", "E110/E510, M210/M610, cálculos e agregações")

    Container(Infra, "Corporate.Contta.Schedule.Infra")
    Component(Repos, "Repositórios Mongo", "INfeRepository, ICompanyRepository...")
    Component(Crawl, "Crawlers AngleSharp", "Consulta anexos/NCM")
    Component(Token, "ConvertTokenId", "Parsing JWT")

    Rel(CtrlNfe, Mediatr, "Send/Handle")
    Rel(CtrlImp, Mediatr, "Send/Handle")
    Rel(CtrlComp, Mediatr, "Send/Handle")
    Rel(CtrlAgE, Mediatr, "Send/Handle")
    Rel(CtrlAccess, Mediatr, "GenerateAccessToken via IUserApplication")
    Rel(Mediatr, Repos, "Repos/Queries")
    Rel(Repos, EntNfe, "Mapeia documentos Mongo -> entidades")
```
